<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Infogr√°fico F&H - Octubre 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #F4F4F4;
      }
      .kpi-card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        transition: all 0.3s ease-in-out;
      }
      .kpi-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
      }
      .kpi-value {
        font-size: 2.5rem;
        font-weight: 900;
        line-height: 1.2;
        color: #333333;
      }
      .kpi-label {
        font-size: 1rem;
        font-weight: 600;
        color: #666666;
        margin-bottom: 0.5rem;
      }
      .kpi-change-green {
        color: #16a34a;
        font-weight: 600;
      }
      .kpi-change-red {
        color: #dc2626;
        font-weight: 600;
      }
      .kpi-change-neutral {
        color: #f59e0b; /* Yellow/Orange for neutral changes */
        font-weight: 600;
      }
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        height: 250px; /* Standard chart height */
        max-height: 35vh;
      }
      .meli-yellow-bg {
        background-color: #FFE600;
      }
      h1 { font-weight: 900; }
      h2 { font-weight: 900; }
      h3 { font-weight: 700; }
      
      .main-header-kpi .kpi-value {
          font-size: 3rem; 
          line-height: 1.1;
      }
      .main-header-kpi .kpi-label-large {
          font-size: 1.1rem; 
          font-weight: 700;
      }

      .topline-summary-box {
        background-color: white;
        border: 1px solid #FFE600; 
        border-radius: 0.5rem;
        padding: 1rem;
        max-width: 100%;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-size: 0.95rem;
        line-height: 1.4;
      }
      .topline-summary-box strong {
          font-weight: 700;
      }
      /* --- AGG1 CHART GRID FIX START --- */
      .agg1-chart-grid {
        display: grid;
        /* Default: 1 column on small screens */
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      /* Tablet and Desktop: Force 2 columns */
      @media (min-width: 768px) {
          .agg1-chart-grid {
              grid-template-columns: repeat(2, 1fr);
          }
      }
      /* Large Desktop: Force 3 columns for better horizontal use */
      @media (min-width: 1280px) {
          .agg1-chart-grid {
              grid-template-columns: repeat(3, 1fr);
          }
      }
      /* --- AGG1 CHART GRID FIX END --- */
      .hidden-by-filter {
          display: none;
      }
      .section-header-with-kpi {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
      }
      .hunting-kpi-inline .kpi-value {
          font-size: 2rem;
          line-height: 1;
      }
      .hunting-kpi-inline .kpi-label {
          font-size: 0.8rem;
          font-weight: 700;
          margin-bottom: 0;
      }
      .chart-container-compact {
          position: relative;
          width: 100%;
          height: 120px; /* Reduced height for clean site comparison charts */
          max-height: 20vh;
      }
      .asp-chart-container {
        position: relative;
        width: 100%;
        height: 180px; /* Specific height for horizontal bar charts */
      }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-4">
            <div>
                <h1 class="text-3xl md:text-5xl">Reporte Mensual F&H</h1>
                <p class="text-xl md:text-2xl text-gray-600 font-semibold">Octubre 2025 ‚Äì MELI (LATAM)</p>
            </div>
            <!-- NMV YTD (This card now updates dynamically based on the selected site's YTD SUM) -->
            <div id="mainKpiCard" class="kpi-card text-black p-6 mt-4 md:mt-0 meli-yellow-bg min-w-[300px] shadow-lg main-header-kpi">
                <div class="kpi-label text-gray-700 font-bold text-center kpi-label-large">NMV YTD (USD - Ene - Oct '25)</div>
                <div class="text-center mt-3">
                    <div id="mainKpiValue" class="kpi-value text-black">5.263 M</div>
                    <div class="flex justify-around text-sm font-semibold mt-2">
                        <span class="text-gray-800">vs. Plan: <span id="mainKpiVsPlan" class="kpi-change-red">-7% üî¥</span></span>
                        <span class="text-gray-800">YoY: <span id="mainKpiYoY" class="kpi-change-green">28% üü¢</span></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- GLOBAL SITE FILTER -->
        <div class="flex items-center justify-end mb-8">
            <label for="siteSelectorGlobal" class="text-lg font-semibold text-gray-700 mr-3">Filtrar por Sitio:</label>
            <select id="siteSelectorGlobal" class="border border-gray-400 rounded-lg p-2 text-base font-bold shadow-sm focus:border-yellow-500 focus:ring-yellow-500 transition duration-150">
                <option value="LATAM">LATAM - Agregado (USD)</option>
                <option value="MLB">MLB - Brasil (BRL)</option>
                <option value="MLM">MLM - M√©xico (MXN)</option>
                <option value="MLA">MLA - Argentina (ARS)</option>
                <option value="MLC">MLC - Chile (CLP)</option>
                <option value="MCO">MCO - Colombia (COP)</option>
                <option value="MLU">MLU - Uruguay (UYU)</option>
                <option value="MPE">MPE - Per√∫ (PEN)</option>
            </select>
        </div>


        <!-- 1. PERFORMANCE GENERAL (Octubre '25) -->
        <section id="performance-topline-agg1" class="mb-10">
            <div class="header-and-summary">
                <h2 class="text-2xl md:text-3xl mb-4">Performance General (Octubre '25)</h2>
                
                <!-- TOP LINE ANALYSIS -->
                <div id="toplineSummaryBox" class="topline-summary-box">
                    <p class="font-bold text-base mb-2">AN√ÅLISIS TOP LINE</p>
                    <p id="toplineSummaryText">
                        F&H cierra Octubre con <strong>$526.7 M USD</strong> (+29% YoY, -7% vs. Plan). Este es el <i>miss</i> m√°s severo del a√±o. El <strong>TSI</strong> fue el motor de crecimiento (+40% YoY, +11% vs Plan), pero fue neutralizado por la contracci√≥n significativa del <strong>TASP</strong> (-8.5% YoY, -16% vs Plan). La <strong>DC</strong> se deterior√≥ <strong>-4.0 pp YoY</strong> (datos LATAM), impactada por mayores costos de distribuci√≥n (<i>shipping</i>), incrementos en la inversi√≥n comercial (<i>Project Manhattan</i>) y menor penetraci√≥n de <i>Ads</i>. La alerta clave es la debilidad en el precio y la rentabilidad.
                    </p>
                </div>
            </div>
            
            <!-- Big Numbers Row -->
            <div id="bigNumbersRow" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <!-- NMV -->
                <div class="kpi-card text-center">
                    <div id="kpiNmvLabel" class="kpi-label">NMV (USD M)</div>
                    <div id="kpiNmvValue" class="kpi-value">527 M</div>
                    <div class="flex justify-between text-xs mt-2">
                        <span id="kpiNmvMoM" class="kpi-change-green">üü¢ +8.0% MoM</span>
                        <span id="kpiNmvYoY" class="kpi-change-green">üü¢ 28% YoY</span>
                        <span id="kpiNmvPlan" class="kpi-change-red">üî¥ -7% vs Plan</span>
                    </div>
                </div>
                <!-- TSI -->
                <div class="kpi-card text-center">
                    <div id="kpiNsiLabel" class="kpi-label">TSI (K)</div>
                    <div id="kpiNsiValue" class="kpi-value">24.49 M</div>
                    <div class="flex justify-between text-xs mt-2">
                        <span id="kpiNsiMoM" class="kpi-change-green">üü¢ +10.7% MoM</span>
                        <span id="kpiNsiYoY" class="kpi-change-green">üü¢ 40% YoY</span>
                        <span id="kpiNsiPlan" class="kpi-change-green">üü¢ +11% vs Plan</span>
                    </div>
                </div>
                <!-- TASP -->
                <div class="kpi-card text-center">
                    <div id="kpiNaspLabel" class="kpi-label">TASP (USD)</div>
                    <div id="kpiNaspValue" class="kpi-value">$21.5</div>
                    <div class="flex justify-between text-xs mt-2">
                        <span id="kpiNaspMoM" class="kpi-change-red">üî¥ -2.6% MoM</span>
                        <span id="kpiNaspYoY" class="kpi-change-red">üî¥ -8.5% YoY</span>
                        <span id="kpiNaspPlan" class="kpi-change-red">üî¥ -16% vs Plan</span>
                    </div>
                </div>
                <!-- DC -->
                <div class="kpi-card text-center">
                    <div id="kpiDcLabel" class="kpi-label">DC (%)</div>
                    <div id="kpiDcValue" class="kpi-value">5.2%</div>
                    <div class="flex justify-around text-xs mt-2">
                        <span id="kpiDcMoM" class="kpi-change-red">üî¥ +3.2 pp MoM</span>
                        <span id="kpiDcYoY" class="kpi-change-red">üî¥ -0.5 pp YoY</span>
                    </div>
                </div>
                <!-- CVR -->
                <div class="kpi-card text-center">
                    <div id="kpiCvrLabel" class="kpi-label">CVR (%)</div>
                    <div id="kpiCvrValue" class="kpi-value">2.5%</div>
                    <div class="flex justify-around text-xs mt-2">
                        <span id="kpiCvrMoM" class="kpi-change-green">üü¢ +0.1 pp MoM</span>
                        <span id="kpiCvrYoY" class="kpi-change-green">üü¢ +0.1 pp YoY</span>
                    </div>
                </div>
            </div>

            
            <!-- Fila 1: Tendencias NMV, NSI, NASP -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- NMV -->
                <div class="kpi-card">
                    <h3 id="nmvChartTitle" class="text-lg mb-1 text-xs">NMV: 527 M | YoY: 28% | MoM: +8.0%</h3>
                    <div class="chart-container">
                        <canvas id="nmvChart"></canvas>
                    </div>
                </div>
                <!-- TSI -->
                <div class="kpi-card">
                    <h3 id="nsiChartTitle" class="text-lg mb-1 text-xs">TSI: 24.49 M | YoY: 40% | MoM: +10.7%</h3>
                    <div class="chart-container">
                        <canvas id="nsiChart"></canvas>
                    </div>
                </div>
                <!-- TASP -->
                <div class="kpi-card">
                    <h3 id="naspChartTitle" class="text-lg mb-1 text-xs">TASP: $21.5 | YoY: -8.5% | MoM: -2.6%</h3>
                    <div class="chart-container">
                        <canvas id="naspChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Fila 2: Tendencias DC, CVR -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- DC -->
                <div class="kpi-card md:col-span-1">
                    <h3 id="dcChartTitle" class="text-lg mb-1 text-xs">DC: 5.2% | YoY: -0.5 pp | MoM: +3.2 pp</h3>
                    <div class="chart-container">
                        <canvas id="dcChart"></canvas>
                    </div>
                </div>
                <!-- CVR -->
                <div class="kpi-card md:col-span-1">
                    <h3 id="cvrChartTitle" class="text-lg mb-1 text-xs">CVR: 2.5% | YoY: +0.1 pp | MoM: +0.1 pp</h3>
                    <div class="chart-container">
                        <canvas id="cvrChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 2. PERFORMANCE NMV PER AGG1 (USD) -->
        <section id="agg1-site-evolution" class="mb-10">
            <h2 id="agg1EvolutionTitle" class="text-2xl md:text-3xl mb-4">Performance NMV per AGG1 (USD)</h2>
            <!-- AN√ÅLISIS DIN√ÅMICO AGG1 -->
            <div id="agg1SummaryBox" class="topline-summary-box">
                <p class="font-bold text-base mb-2">AN√ÅLISIS DIN√ÅMICO AGG1</p>
                <p id="agg1AnalysisText" class="text-base text-gray-800">
                    <!-- El texto se inyecta v√≠a JS -->
                </p>
            </div>
            
            <div id="agg1ChartsContainer" class="agg1-chart-grid">
                <!-- Charts will be dynamically inserted here by JavaScript -->
            </div>
        </section>

        <!-- 3. RANGO DE TASP (ASP Range) -->
        <section id="asp-range-section" class="mb-10">
            <h2 id="aspRangeTitle" class="text-2xl md:text-3xl mb-4">Rango de TASP (ASP Range) - NMV por Rango de Precio</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <!-- NMV per ASP Range -->
                <div class="kpi-card">
                    <h3 class="text-lg font-bold mb-3 text-center">NMV vs. ASP Range</h3>
                    <div class="asp-chart-container">
                        <canvas id="aspNmvChart"></canvas>
                    </div>
                </div>
                <!-- TSI per ASP Range -->
                <div class="kpi-card">
                    <h3 class="text-lg font-bold mb-3 text-center">TSI vs. ASP Range</h3>
                    <div class="asp-chart-container">
                        <canvas id="aspNsiChart"></canvas>
                    </div>
                </div>
                <!-- DC per ASP Range -->
                <div class="kpi-card">
                    <h3 class="text-lg font-bold mb-3 text-center">DC vs. ASP Range</h3>
                    <div class="asp-chart-container">
                        <canvas id="aspDcChart"></canvas>
                    </div>
                </div>
                <!-- CVR per ASP Range -->
                <div class="kpi-card">
                    <h3 class="text-lg font-bold mb-3 text-center">CVR vs. ASP Range</h3>
                    <div class="asp-chart-container">
                        <canvas id="aspCvrChart"></canvas>
                    </div>
                </div>
                <!-- BPC per ASP Range -->
                <div class="kpi-card">
                    <h3 class="text-lg font-bold mb-3 text-center">BPC vs. ASP Range</h3>
                    <div class="asp-chart-container">
                        <canvas id="aspBpcChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. SELECCI√ìN & PRICING QUALITY -->
        <section id="seleccion" class="mb-10">
            <div class="section-header">
                <h2 class="text-2xl md:text-3xl mb-4">Selecci√≥n & Pricing Quality</h2>
            </div>
            <!-- AN√ÅLISIS DE SECCI√ìN -->
            <div id="seleccionSummaryBox" class="topline-summary-box">
                <p class="font-bold text-base mb-2">AN√ÅLISIS DE SELECCI√ìN Y PRICING</p>
                <p id="seleccionSummaryText">
                    La selecci√≥n de productos clave (<strong>KMI Coverage 97.4%</strong>) se mantiene robusta. Sin embargo, la competitividad de precios es una preocupaci√≥n seria: el <strong>BPC Total (66.9%)</strong> ha ca√≠do <strong>-1.8 pp YoY</strong>, lo que contribuye directamente a la contracci√≥n del TASP. Este <i>drag</i> es liderado por MLB (-2.8 pp), impactado por competidores asi√°ticos. Aunque el BPC muestra una mejora MoM desde Agosto (+1.4 pp), la presi√≥n por el precio sigue siendo notable en los rangos Low y Mid-Low (ver ASP Range). MLB sigue ganando cuota de mercado con Shopee (40,2% en Septiembre, +5,7 pp YoY).
                </p>
            </div>
            <!-- FIN AN√ÅLISIS -->

            <!-- NMV HUNTING VS PLAN (PDD replacement) -->
            <!-- COVERAGE KPIs ROW - Dynamic Cards (MOVED UP) -->
            <h3 class="text-xl font-bold mb-4">Selection</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                
                <!-- KMI Coverage (Using actual data) -->
                <div class="kpi-card text-center flex flex-col justify-center">
                    <div class="kpi-label">KMI Coverage (% Found)</div>
                    <div id="kmiCoverageValue" class="kpi-value">97.4%</div>
                    <p id="kmiCoverageStatus" class="text-lg font-bold kpi-change-green">üü¢ OK</p>
                    <p class="text-gray-700 mt-4 text-sm">
                        La cobertura de √≠tems clave se mantiene saludable. (YoY: <span id="kmiCoverageYoY">+0.9 pp</span>)
                    </p>
                </div>
                
                <!-- Overall BPC (Using actual data) -->
                <div class="kpi-card text-center flex flex-col justify-center">
                    <div class="kpi-label">BPC Total (%)</div>
                    <div id="bpcTotalValue" class="kpi-value">66.9%</div>
                    <p id="bpcTotalStatus" class="text-lg font-bold kpi-change-neutral">üü° Foco</p>
                    <p class="text-gray-700 mt-4 text-sm">
                        BPC general bajo. Necesidad de aumentar la competitividad de precios, especialmente en rangos altos de ASP. (YoY: <span id="bpcTotalYoY">-1.8 pp</span>)
                    </p>
                </div>
                
                <!-- NMV HUNTING VS PLAN (PDD replacement) -->
                <div class="kpi-card text-center flex flex-col justify-center">
                    <div class="kpi-label">NMV Hunting vs Plan</div>
                    <div id="kpiNmvHuntingValue" class="kpi-value">2.1%</div>
                    <p id="kpiNmvHuntingStatus" class="text-lg font-bold kpi-change-red">üî¥ Alerta</p>
                    <p class="text-gray-700 mt-4 text-sm">
                        Plan de crecimiento de NMV para Hunting Categories vs. Target. (vs Plan: <span id="kpiNmvHuntingPlan">-7%</span>)
                    </p>
                </div>
            </div>
            <!-- FIN COVERAGE KPIs ROW -->

            <h3 class="text-xl font-bold mb-4">Performance BPC - √öltimos 6 meses (<span id="bpcChartSiteName">LATAM Agregado</span>)</h3>
            <!-- BPC LINE CHARTS ROW (Static Aggregated Charts) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="kpi-card">
                    <h4 class="text-base font-semibold mb-1 text-center">Price BPC KMI (%)</h4>
                    <div class="chart-container-compact">
                        <canvas id="bpcKiChart"></canvas>
                    </div>
                </div>
                <div class="kpi-card">
                    <h4 class="text-base font-semibold mb-1 text-center">BPC Financing (0% Inter√©s) (%)</h4>
                    <div class="chart-container-compact">
                        <canvas id="bpcFinancingChart"></canvas>
                    </div>
                </div>
                <div class="kpi-card">
                    <h4 class="text-base font-semibold mb-1 text-center">BPC Shipping (Env√≠o Gratis) (%)</h4>
                    <div class="chart-container-compact">
                        <canvas id="bpcShippingChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- FIN BPC LINE CHARTS ROW -->
        </section>

        <!-- 5. SECTION PRODUCTO & EXPERIENCE -->
        <section id="producto" class="mb-10">
            <h2 class="text-2xl md:text-3xl mb-4">Producto & Experiencia - Calidad Log√≠stica (PDD)</h2>
            <!-- AN√ÅLISIS DE SECCI√ìN -->
            <div id="productSummaryBox" class="topline-summary-box">
                <p class="font-bold text-base mb-2">AN√ÅLISIS DE PRODUCTO Y EXPERIENCIA</p>
                <p id="productSummaryText">
                    La calidad de entrega es una alarma roja: <strong>PDD Total (2.1% en Octubre)</strong> muestra un deterioro significativo post-septiembre, con crecimientos YoY en <strong>MLB (+0.22 pp)</strong>, <strong>MLA (+0.17 pp)</strong> y <strong>MCO (+0.23 pp)</strong>. Este aumento est√° directamente correlacionado con la ganancia de NMV SoB de <strong>Furniture</strong> (que representa cerca del 65% del PDD total), lo que sugiere que la log√≠stica de <i>Big Items</i> sigue siendo un desaf√≠o operativo. La reducci√≥n del PNR YoY en casi todos los sitios ofrece un contrapeso positivo, indicando mejoras en la precisi√≥n de entrega, pero no en la calidad del producto recibido.
                </p>
            </div>
            <!-- FIN AN√ÅLISIS -->
            
            <!-- PDD CHART AND NOVEDADES CONTAINER -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="kpi-card">
                    <h3 class="text-lg font-bold m-0 p-0 mb-3">Evoluci√≥n PDD por Sitio Seleccionado</h3>
                    <h4 id="pddChartTitle" class="text-center text-sm font-semibold mb-3">PDD Vertical vs. H&B (LATAM - √öltimos 6 meses)</h4>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="pddQualityChart"></canvas>
                    </div>
                    <p class="text-xs text-gray-600 mt-2 text-center">
                        La l√≠nea punteada indica el PDD Target/Alerta (se usar√° target 2.5% para H&B).
                    </p>
                </div>
                
                <!-- NOVEDADES DE PRODUCTO -->
                <div class="kpi-card">
                    <h3 class="text-xl font-bold mb-3 flex items-center">‚ú® Novedades de Producto & Experiencia</h3>
                    
                    <div class="space-y-4">
                        <div class="border-l-4 border-yellow-500 pl-3">
                            <p class="font-bold text-sm">Scorecard de Calidad para Sellers</p>
                            <p class="text-gray-700 text-sm">Prueba piloto en MLB iniciada. Monitoreo constante de PDD y NPS para identificar los <i>sellers</i> de bajo rendimiento en Furniture y Mattresses, mitigando riesgos de calidad.</p>
                        </div>
                        <div class="border-l-4 border-yellow-500 pl-3">
                            <p class="font-bold text-sm">NPS Buyer & Seller</p>
                            <p class="text-gray-700 text-sm">Se mantiene estable. La mejora en PNR (-0,24 pp en MLA, -0,15 pp en MLU, etc.) muestra que la precisi√≥n mejor√≥. El foco es atacar la causa ra√≠z del PDD (da√±o en <i>Big Items</i>) para Q4.</p>
                        </div>
                        <div class="border-l-4 border-yellow-500 pl-3">
                            <p class="font-bold text-sm">Iniciativas Clave (CVR, Tags)</p>
                            <p class="text-gray-700 text-sm">CVR fuerte (2.5%), por encima del promedio del vertical. Se lanz√≥ el <i>tag</i> "Env√≠o R√°pido Big Item" en Octubre para mitigar el efecto negativo en KB#2 (Furniture).</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. KEY BATTLES SECTION -->
        <section id="key-battles" class="mb-10">
            <h2 class="text-2xl md:text-3xl mb-4">Batallas Clave (Key Battles) - Avance de Estrategia</h2>
            <!-- AN√ÅLISIS DE SECCI√ìN -->
            <div id="keyBattlesSummaryBox" class="topline-summary-box">
                <p class="font-bold text-base mb-2">AN√ÅLISIS DE KEY BATTLES</p>
                <p id="keyBattlesSummaryText">
                    El crecimiento en Mattresses, HHI, y Decor (+33% a +41% YoY) demuestran la tracci√≥n de las categor√≠as de alto volumen. La principal alerta reside en <strong>KB#2: Furniture (Big Items)</strong>, que crece <strong>2 pp por debajo del vertical</strong>. Este <i>drag</i> est√° impulsado principalmente por <strong>MLB (28% YoY)</strong>, <strong>MLA (17% YoY)</strong> y <strong>MLU (26% YoY)</strong>. En contraste, <strong>MLC (+60% YoY)</strong> y <strong>MPE (+43% YoY)</strong> muestran un rendimiento excepcional, superando el crecimiento de la KB total por +33 pp y +16 pp respectivamente.
                </p>
            </div>
            <!-- FIN AN√ÅLISIS -->
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="kpi-card">
                    <h3 class="text-xl mb-3">KB#1: Household Items Low-to-Mid Price (LATAM)</h3>
                    <p class="text-sm text-gray-500">(NMV Target USD 238 M)</p>
                    <div class="kpi-value my-2" style="color: #6A2C70;">245 M USD</div>
                    <div class="text-xl font-bold kpi-change-green mb-3">üü¢ +3% vs. Plan</div>
                    <p class="text-gray-700">
                        <strong>An√°lisis Cualitativo:</strong> El rendimiento en art√≠culos de hogar (que incluye el fuerte crecimiento de Decor +41.3% MoM) valida la estrategia de volumen en la franja de precios bajos. Es crucial estabilizar este crecimiento con foco en TASP neutral para evitar mayor diluci√≥n.
                    </p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-xl mb-3">KB#2: Furniture (Big Items) Latam</h3>
                    <p class="text-sm text-gray-500">(NMV Target USD 336 M)</p>
                    <div class="kpi-value my-2" style="color: #B83B5E;">305 M USD</div>
                    <div class="text-xl font-bold kpi-change-red mb-3" style="color: #F08A5D;">üî¥ -9% vs. Plan</div>
                    <p class="text-gray-700">
                        <strong>An√°lisis Cualitativo:</strong> La ca√≠da del -9% vs Plan se debe a: <strong>(1)</strong> Debilidad en BPC en √≠tems de alto valor. <strong>(2)</strong> Problemas log√≠sticos (PDD) para <i>Big Items</i>. <strong>MLB</strong> est√° <i>underperforming</i> en Furniture (28% YoY) y Textiles (30% YoY), lo que explica gran parte del <i>gap</i> regional.
                    </p>
                </div>
            </div>
        </section>

        <!-- 7. CONDITIONAL SECTION: LOGISTICS FOCUS (MLB HOUSEWARE) - MOVED HERE -->
        <section id="plan-mlb-houseware" class="mb-10 hidden-by-filter">
            <h2 class="text-2xl md:text-3xl mb-4">Enfoque Log√≠stico: MLB Household Items (Solo MLB y LATAM)</h2>
            <!-- AN√ÅLISIS DE SECCI√ìN -->
            <div id="logisticsSummaryBox" class="topline-summary-box">
                <p class="font-bold text-base mb-2">AN√ÅLISIS LOG√çSTICO (MLB)</p>
                <p id="logisticsSummaryText">
                    A pesar de que el Leadtime y la Disponibilidad se mantienen bien en MLB, el foco debe centrarse en la calidad de entrega debido al aumento del <strong>PDD (+0.22 pp YoY)</strong>, explicado por la ganancia de SoB de Furniture (que representa casi el 65% del PDD total). La buena noticia es la mejora en las m√©tricas de <i>Product Not Received</i> (PNR), con MLB cerrando <strong>-0.21 pp YoY</strong> en el PNR general de F&H H&B, lo que indica un avance en la experiencia del cliente.
                </p>
            </div>
            <!-- FIN AN√ÅLISIS -->
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="kpi-card">
                    <div class="kpi-label">Leadtime Total</div>
                    <div class="kpi-value">3 D√≠as <span class="text-2xl kpi-change-green">üü¢</span></div>
                    <p class="text-gray-700 mt-2">
                        <strong>Insight:</strong> El Leadtime se mantiene bajo (3 D√≠as), lo cual es crucial para la promesa de valor de H&B. Esto debe monitorearse de cerca en vista del <strong>Hot Sale (Nov)</strong>.
                    </p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">PNR (Product Not Received) YoY Change</div>
                    <div class="kpi-value text-xl" style="font-weight: 900;">-0.21 pp <span class="text-2xl kpi-change-green">üü¢</span></div>
                    <p class="text-gray-700 mt-2">
                        <strong>Insight:</strong> Mejora significativa en el PNR de F&H H&B. Este <i>driver</i> de experiencia debe mantenerse para Q4.
                    </p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Disponibilidad (%)</div>
                    <div class="kpi-value">98% <span class="text-2xl kpi-change-green">üü¢</span></div>
                    <p class="text-gray-700 mt-2">
                        <strong>Insight:</strong> La disponibilidad de inventario es alta, lo cual es vital dada la sensibilidad de la demanda a roturas de stock en este segmento y el alto TSI.
                    </p>
                </div>
            </div>
        </section>


        <!-- 8. FOOTER / CTA SECTION -->
        <section id="cta" class="mb-10">
            <h2 class="text-2xl md:text-3xl mb-4">Notas Finales y Call to Action</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Tarjeta 1: Recomendaci√≥n Estrat√©gica -->
                <div class="kpi-card">
                    <h3 class="text-xl mb-2 flex items-center">üí° Recomendaci√≥n Estrat√©gica (KB#2 & Rentabilidad)</h3>
                    <p class="text-gray-700">
                        La estrategia prioritaria es revertir la tendencia de deterioro en <strong>DC/BM</strong> y <strong>TASP</strong>. Para la <strong>KB#2 (Furniture)</strong> se debe: <strong>1)</strong> Aumentar agresivamente el <strong>BPC Price</strong> en el rango <strong>HIGH</strong> (>$100 USD), atacando el <i>gap</i> de NMV. <strong>2)</strong> Mitigar inmediatamente el <strong>PDD</strong> en <i>Big Items</i> (65% del PDD total) con un plan de <i>fulfillment</i> dedicado para Q4.
                    </p>
                </div>
                <!-- Tarjeta 2: Alertas (DC/Plan) -->
                <div class="kpi-card" style="background-color: #fff5f5; border: 1px solid #ef4444;">
                    <h3 class="text-xl mb-2 flex items-center">üî¥ Alertas (Rentabilidad y Gap vs Plan)</h3>
                    <p class="text-gray-700">
                        La contracci√≥n del <strong>TASP (-16% vs Plan)</strong> y el deterioro de la <strong>DC (-4.0 pp YoY)</strong>, impulsados por mayores costos operativos y la estrategia comercial (Manhattan), son alarmas de rentabilidad. Se deben revisar urgentemente las estructuras de costo de <i>shipping</i> y las inversiones en <i>Ads</i> en sitios con <strong>DC negativa o muy baja (MLB 0.4%, MCO -2.2%, MPE -4.3%)</strong>.
                    </p>
                </div>
                <!-- Tarjeta 3 (NUEVA): Pr√≥ximos Pasos (Producto) -->
                <div class="kpi-card">
                    <h3 class="text-xl mb-2 flex items-center">
                        <span class="mr-2 text-xl">‚Üí</span> Pr√≥ximos Pasos (Producto)
                    </h3>
                    <p class="text-gray-700">
                        <strong>1. Mitigaci√≥n de PDD:</strong> Enfocarse en la trazabilidad del PDD asociado a Furniture en los sitios con mayor repunte (MLB, MLA, MCO). <strong>2. Scorecards:</strong> Implementar el Scorecard de Calidad para <i>sellers</i> de Mattresses y Furniture antes del Black Friday/Hot Sale.
                    </p>
                </div>
                <!-- Tarjeta 4 (NUEVA): Next Steps (Selecci√≥n) -->
                <div class="kpi-card">
                    <h3 class="text-xl mb-2 flex items-center">
                        <span class="mr-2 text-xl">‚è±Ô∏è</span> Next Steps (Selecci√≥n)
                    </h3>
                    <p class="text-gray-700">
                        <strong>1. BPC Estrat√©gico:</strong> Priorizar <i>wave</i> de pricing en rangos de <strong>ASP LOW1/LOW2</strong> (mayor sensibilidad al TSI). <strong>2. Contenci√≥n del TASP:</strong> Activar campa√±as de <i>upsell</i> y precios ancla en rangos <strong>MID-HIGH</strong> para estabilizar la contracci√≥n del TASP. <strong>3. Mercados Espec√≠ficos:</strong> Monitorear el <i>underperformance</i> de HHI y Textiles en MLA para mitigar ca√≠das de NMV YoY.
                    </p>
                </div>
            </div>
        </section>

        
    </div>

    <script>
        
        Chart.register(ChartDataLabels);
        var chartInstances = {}; // Centralized chart instance storage
        var kpiLabels = ['May \'25', 'Jun \'25', 'Jul \'25', 'Ago \'25', 'Sep \'25', 'Oct \'25'];
        
        // ASP Labels are now dynamically generated by aspRangesBySite
        var meliYellow = '#FFE600';
        var meliYellowBg = 'rgba(255, 230, 0, 0.5)';
        var color2 = '#B83B5E';  
        var color2Bg = 'rgba(184, 59, 94, 0.5)';
        var color4 = '#6A2C70';  
        var color4Bg = 'rgba(106, 44, 112, 0.5)'; 
        var color3 = '#F08A5D';  
        var color3Bg = 'rgba(240, 138, 93, 0.5)';
        var color5 = '#3C989C'; 
        var color5Bg = 'rgba(60, 152, 156, 0.5)';
        var color6 = '#2C5E70';
        var color6Bg = 'rgba(44, 94, 112, 0.5)';

        // --- NEW ASP RANGE DEFINITION (Based on image) ---
        var aspRangesBySite = {
            LATAM: ['LOW1 [0-5USD]', 'LOW2 [5-10USD]', 'LOW3 [10-20USD]', 'MID1 [20-40USD]', 'MID2 [40-60USD]', 'MID-HIGH [60-100USD]', 'HIGH [+100USD]'],
            MLB: ['LOW1 [0-10]', 'LOW2 [10-19]', 'LOW3 [19-79]', 'MID1 [79-120]', 'MID2 [120-200]', 'MID-HIGH [200-500]', 'HIGH [>500]'],
            MLM: ['LOW1 [0-150]', 'LOW2 [150-300]', 'LOW3 [300-500]', 'MID1 [500-1000]', 'MID2 [1000-2000]', 'MID-HIGH [2000-3000]', 'HIGH [>3000]'],
            MLA: ['LOW1 [0-6980]', 'LOW2 [6980-13960]', 'LOW3 [13960-20940]', 'MID1 [20940-41880]', 'MID2 [41880-69800]', 'MID-HIGH [69800-104700]', 'HIGH [>104700]'],
            MLC: ['LOW1 [0-9990]', 'LOW2 N/A', 'LOW3 [9990-19990]', 'MID1 [19990-39990]', 'MID2 [39990-99990]', 'MID-HIGH N/A', 'HIGH [>99990]'],
            MCO: ['LOW1 [0-60000]', 'LOW2 N/A', 'LOW3 [60000-90000]', 'MID1 [90000-117000]', 'MID2 [117000-195000]', 'MID-HIGH N/A', 'HIGH [>195000]'],
            MLU: ['LOW1 [0-400]', 'LOW2 [400-800]', 'LOW3 [800-1200]', 'MID1 [1200-1500]', 'MID2 [1500-2000]', 'MID-HIGH [2000-5000]', 'HIGH [>5000]'],
            MPE: ['LOW1 [0-39]', 'LOW2 N/A', 'LOW3 [39-79]', 'MID1 N/A', 'MID2 [79-189]', 'MID-HIGH [189-379]', 'HIGH [>379]']
        };
        
        // --- NEW ASP RANGE DATA (7 values per KPI, 0 for N/A ranges) ---
        // Indices correspond to aspRangesBySite order (LOW1 to HIGH)
        var aspRangeData = {
            LATAM: {
                nmv: [150, 250, 126, 80, 50, 30, 20], 
                nsi: [12000, 8000, 4490, 3000, 2000, 1000, 500], 
                dc: [6.5, 4.0, 2.5, 2.0, 1.5, 1.0, 0.5], 
                cvr: [2.8, 2.4, 2.0, 1.8, 1.5, 1.2, 1.0], 
                bpc: [88.0, 80.0, 65.0, 60.0, 55.0, 50.0, 45.0] 
            },
            MLB: {
                nmv: [0.5, 0.7, 0.4, 0.2, 0.1, 0.05, 0.02], 
                nsi: [8000, 4000, 2544, 1500, 800, 400, 200], 
                dc: [7.0, 3.0, 1.5, 1.0, 0.5, 0.2, 0.1], 
                cvr: [3.0, 2.5, 2.2, 2.0, 1.8, 1.5, 1.2], 
                bpc: [90.0, 78.0, 60.0, 55.0, 50.0, 45.0, 40.0]
            },
            MLM: {
                nmv: [0.8, 1.0, 0.34, 0.2, 0.1, 0.05, 0.01], 
                nsi: [3000, 1500, 896, 500, 200, 100, 50], 
                dc: [8.5, 6.0, 3.0, 2.0, 1.0, 0.5, 0.2], 
                cvr: [2.8, 2.3, 1.9, 1.5, 1.2, 1.0, 0.8], 
                bpc: [92.0, 85.0, 70.0, 65.0, 60.0, 55.0, 50.0]
            },
            MLA: {
                nmv: [45, 50, 22.9, 15, 10, 5, 2], 
                nsi: [2000, 700, 419, 200, 100, 50, 20], 
                dc: [10.0, 8.0, 4.5, 3.0, 2.0, 1.0, 0.5], 
                cvr: [2.2, 1.8, 1.5, 1.2, 1.0, 0.8, 0.5], 
                bpc: [95.0, 80.0, 60.0, 55.0, 50.0, 45.0, 40.0]
            },
            MLC: {
                nmv: [6, 0, 7, 2, 1, 0, 0.5], // LOW2, MID-HIGH are N/A (index 1 and 5 are 0)
                nsi: [500, 0, 300, 150, 80, 0, 30], 
                dc: [8.0, 0, 5.0, 3.0, 2.0, 0, 0.5], 
                cvr: [3.5, 0, 3.0, 2.5, 2.0, 0, 1.5], 
                bpc: [80.0, 0, 70.0, 60.0, 55.0, 0, 40.0]
            },
            MCO: {
                nmv: [8, 0, 10, 5, 3, 0, 1], // LOW2, MID-HIGH are N/A (index 1 and 5 are 0)
                nsi: [100, 0, 80, 50, 30, 0, 10], 
                dc: [3.0, 0, 1.5, 1.0, 0.5, 0, 0.1], 
                cvr: [2.5, 0, 2.0, 1.8, 1.5, 0, 1.0], 
                bpc: [85.0, 0, 75.0, 65.0, 55.0, 0, 45.0]
            },
            MLU: {
                nmv: [150, 100, 95.86, 50, 30, 10, 5], 
                nsi: [100, 80, 46.12, 30, 15, 8, 4], 
                dc: [8.0, 5.0, 2.0, 1.5, 1.0, 0.5, 0.2], 
                cvr: [2.0, 1.5, 1.0, 0.8, 0.6, 0.4, 0.2], 
                bpc: [98.0, 85.0, 70.0, 65.0, 60.0, 55.0, 50.0]
            },
            MPE: {
                nmv: [0.5, 0, 0.6, 0, 0.32, 0.1, 0.05], // LOW2, MID1 are N/A (index 1 and 3 are 0)
                nsi: [4.0, 0, 3.0, 0, 1.19, 0.5, 0.1], 
                dc: [2.0, 0, 0.5, 0, 0.1, 0.05, 0.01], 
                cvr: [1.5, 0, 1.0, 0, 0.8, 0.5, 0.2], 
                bpc: [75.0, 0, 65.0, 0, 55.0, 45.0, 30.0]
            }
        };

        var dynamicKpiData = {
            LATAM: {
                nmv: { current: 526.3, mom: 8.1, yoy: 28, plan: -7, unit: 'M USD', nominals: [478.0, 474.7, 514.6, 502.5, 486.7, 526.3], yoyHist: [28, 36, 30, 29, 30, 28], planNeeded: true },
                nsi: { current: 24490, mom: 10.7, yoy: 40, plan: 11, unit: 'K', nominals: [19190, 20320, 22760, 22700, 22120, 24490], yoyHist: [27, 36, 35, 38, 39, 40], planNeeded: true },
                nasp: { current: 21.5, mom: -2.6, yoy: -8.5, plan: -16.0, unit: 'USD', nominals: [25.0, 23.0, 23.0, 22.0, 22.0, 21.5], yoyHist: [1.0, 0.0, -4.0, -6.3, -6.5, -8.5], planNeeded: true },
                dc: { current: 5.2, mom: 3.2, yoy: -0.5, unit: '%', nominals: [5.6, 3.7, 3.2, 2.6, 2.0, 5.2], yoyHist: [-1.6, -3.3, -3.6, -3.6, -4.0, -0.5], isDifferential: true },
                cvr: { current: 2.5, mom: 0.1, yoy: 0.1, unit: '%', nominals: [2.4, 2.5, 2.4, 2.4, 2.4, 2.5], yoyHist: [0.1, 0.1, 0.1, 0.0, -0.1, 0.1], isDifferential: true },
                kmiCoverage: { current: 97.4, yoy: 0.9 }, bpcTotal: { current: 66.9, yoy: -1.8 }, pddTotal: { current: 2.1, yoy: 0.2 },
                summary: 'F&H cierra Octubre con <strong>%NMV_VAL%</strong> (+29% YoY, -7% vs. Plan). Este es el <i>miss</i> m√°s severo del a√±o. El <strong>TSI</strong> fue el motor de crecimiento (+40% YoY, +11% vs Plan), pero fue neutralizado por la contracci√≥n significativa del <strong>TASP</strong> (-8.5% YoY, -16% vs Plan). La <strong>DC</strong> se deterior√≥ <strong>-4.0 pp YoY</strong> (datos LATAM), impactada por mayores costos de distribuci√≥n (<i>shipping</i>), incrementos en la inversi√≥n comercial (<i>Project Manhattan</i>) y menor penetraci√≥n de <i>Ads</i>. La alerta clave es la debilidad en el precio y la rentabilidad.'
            },
            MLB: {
                nmv: { current: 1.60, mom: 10.0, yoy: 30.9, plan: -4.0, unit: 'B BRL', nominals: [1.29, 1.37, 1.51, 1.50, 1.46, 1.60], yoyHist: [26.7, 29.8, 27.8, 31.5, 33.0, 30.9], planNeeded: true },
                nsi: { current: 14544, mom: 11.6, yoy: 43.2, plan: 2.0, unit: 'K', nominals: [10373, 11631, 13141, 13215, 13027, 14544], yoyHist: [17.6, 28.7, 30.5, 36.6, 41.0, 43.2], planNeeded: true },
                nasp: { current: 20.0, mom: -7.4, yoy: -5, plan: -5.0, unit: 'BRL', nominals: [22, 21, 21, 21, 21, 20], yoyHist: [-2, -3, -2, -2, -3, -5], planNeeded: true },
                dc: { current: 3.3, mom: 2.9, yoy: -1.9, unit: '%', nominals: [4.5, 1.8, 1.2, 0.9, 0.4, 3.3], yoyHist: [-3.6, -5.7, -5.5, -4.8, -5.3, -1.9], isDifferential: true },
                cvr: { current: 2.7, mom: 0.1, yoy: 0.2, unit: '%', nominals: [2.5, 2.7, 2.6, 2.6, 2.6, 2.7], yoyHist: [0.1, 0.2, 0.1, 0.1, -0.1, 0.2], isDifferential: true },
                kmiCoverage: { current: 98.7, yoy: -0.3 }, bpcTotal: { current: 63.8, yoy: -2.8 }, pddTotal: { current: 1.9, yoy: 0.0 },
                summary: 'MLB cierra Octubre con <strong>%NMV_VAL%</strong> (+30.9% YoY) quedando <strong>-4%</strong> vs Plan. El principal <i>drag</i> viene de Furniture (28% YoY) y Textiles (30% YoY), que est√°n bajo el crecimiento del vertical. El <strong>TASP</strong> cae <strong>-5% YoY</strong>. La <strong>DC</strong> (0.4%) se recupera a 3.3% pero sigue con un <i>gap</i> YoY de <strong>-1.9 pp</strong>, siendo una alerta de rentabilidad.'
            },
            MLM: {
                nmv: { current: 2.14, mom: 8.6, yoy: 39.0, plan: 7.0, unit: 'B MXN', nominals: [2.10, 1.98, 2.15, 2.12, 1.97, 2.14], yoyHist: [34.8, 58.0, 43.9, 44.8, 42.3, 39.0], planNeeded: true },
                nsi: { current: 5396, mom: 13.6, yoy: 44.1, plan: 8.0, unit: 'K', nominals: [4433, 4408, 4964, 5043, 4748, 5396], yoyHist: [38.5, 53.7, 48.0, 51.8, 45.1, 44.1], planNeeded: true },
                nasp: { current: 397.2, mom: -0.9, yoy: 3.0, plan: 0.0, unit: 'MXN', nominals: [473.0, 450.0, 427.0, 420.0, 390.0, 397.2], yoyHist: [-16, -2, -6, -3, 4, 3], planNeeded: true },
                dc: { current: 7.0, mom: 1.9, yoy: 1.9, unit: '%', nominals: [5.7, 4.1, 3.3, 3.5, 1.9, 7.0], yoyHist: [-1.0, -1.2, -3.3, -2.5, -3.8, 1.9], isDifferential: true },
                cvr: { current: 2.4, mom: 0.1, yoy: -0.1, unit: '%', nominals: [2.6, 2.5, 2.4, 2.4, 2.3, 2.4], yoyHist: [-0.0, 0.1, 0.1, 0.0, -0.2, -0.1], isDifferential: true },
                kmiCoverage: { current: 97.1, yoy: 1.2 }, bpcTotal: { current: 75.4, yoy: -1.3 }, pddTotal: { current: 1.4, yoy: 0.0 },
                summary: 'MLM es el <i>top performer</i> del mes, con un crecimiento de <strong>%NMV_VAL%</strong> (+39% YoY) y <strong>+7% vs Plan</strong> en NMV. La fortaleza se ve en <strong>TSI</strong> (<strong>+44% YoY</strong>). La <strong>DC</strong> se recupera a <strong>+1.9 pp YoY</strong>, aunque la <strong>CVR</strong> cay√≥ ligeramente YoY.'
            },
            MLA: {
                nmv: { current: 117.9, mom: 4.2, yoy: 11.2, plan: -10.0, unit: 'B ARS', nominals: [134.5, 111.3, 122.9, 116.1, 113.1, 117.9], yoyHist: [24.5, 31.6, 20.1, 10.6, 13.0, 11.2], planNeeded: true },
                nsi: { current: 3119, mom: 2.7, yoy: 28.6, plan: -5.0, unit: 'K', nominals: [3225, 3013, 3356, 3176, 3039, 3119], yoyHist: [55.5, 52.0, 43.5, 31.7, 31.8, 28.6], planNeeded: true },
                nasp: { current: 26, mom: 3.7, yoy: -22.0, plan: -15.0, unit: 'ARS', nominals: [36, 31, 29, 28, 27, 26], yoyHist: [-11, -8, -16, -21, -22, -22], planNeeded: true },
                dc: { current: 9.4, mom: 30.6, yoy: 1.4, unit: '%', nominals: [7.7, 7.5, 8.3, 6.1, 7.2, 9.4], yoyHist: [0.8, -0.1, 0.0, -1.8, -0.2, 1.4], isDifferential: true },
                cvr: { current: 1.9, mom: 5.6, yoy: -0.0, unit: '%', nominals: [1.9, 1.8, 1.8, 1.8, 1.8, 1.9], yoyHist: [0.2, 0.1, 0.1, -0.0, -0.1, -0.0], isDifferential: true },
                kmiCoverage: { current: 93.4, yoy: -4.7 }, bpcTotal: { current: 77.2, yoy: 12.6 }, pddTotal: { current: 1.8, yoy: 0.0 },
                summary: 'MLA sigue bajo presi√≥n, cerrando <strong>%NMV_VAL%</strong> (<strong>-10% vs Plan</strong>). El <i>gap</i> est√° enteramente impulsado por la contracci√≥n de <strong>TASP</strong> (-29% vs Plan) y el <i>underperformance</i> de HHI (5% YoY) y Textiles (-4% YoY). La <strong>DC</strong> se recupera a <strong>+9.4%</strong> por la estructura de <i>shipping</i>.'
            },
            MLC: {
                nmv: { current: 15.5, mom: 18.9, yoy: 41.3, plan: 0.0, unit: 'B CLP', nominals: [12.1, 14.3, 13.1, 13.2, 13.1, 15.5], yoyHist: [27.5, 38.1, 39.0, 32.5, 29.2, 41.3], planNeeded: true },
                nsi: { current: 966.15, mom: 13.1, yoy: 30.6, plan: 5.0, unit: 'K', nominals: [761.7, 831.2, 837.4, 844.9, 854.4, 966.2], yoyHist: [13.6, 23.3, 26.7, 23.1, 25.2, 30.6], planNeeded: true },
                nasp: { current: 17, mom: 5.9, yoy: 5.0, plan: -2.0, unit: 'CLP', nominals: [17, 18, 17, 16, 16, 17], yoyHist: [10, 10, 8, 4, -1, 5], planNeeded: true },
                dc: { current: 6.9, mom: 9.9, yoy: 0.2, unit: '%', nominals: [7.6, 7.4, 7.1, 6.6, 6.3, 6.9], yoyHist: [0.6, 0.5, 0.2, -0.7, -0.0, 0.2], isDifferential: true },
                cvr: { current: 3.1, mom: 0.0, yoy: -0.4, unit: '%', nominals: [3.4, 3.2, 2.9, 3.1, 3.2, 3.1], yoyHist: [-0.1, -0.1, -0.4, -0.4, -0.3, -0.4], isDifferential: true },
                kmiCoverage: { current: 88.3, yoy: 10.5 }, bpcTotal: { current: 73.0, yoy: 0.1 }, pddTotal: { current: 1.9, yoy: 0.3 },
                summary: 'MLC logra un crecimiento explosivo de <strong>%NMV_VAL%</strong> (<strong>+41.3% YoY</strong>), logrando el <strong>Plan (0% Gap)</strong>. El motor es Furniture (+60% YoY). La <strong>DC</strong> (+6.9%) se mantiene positiva, pero la <strong>CVR</strong> se contrae a <strong>-0.4 pp YoY</strong>.'
            },
            MCO: {
                nmv: { current: 20.7, mom: 10.3, yoy: 24.2, plan: -2.0, unit: 'B COP', nominals: [17.2, 17.3, 21.1, 18.8, 18.7, 20.7], yoyHist: [12.9, 14.8, 26.5, 20.4, 24.5, 24.2], planNeeded: true },
                nsi: { current: 227.44, mom: 8.9, yoy: 17.1, plan: 5.0, unit: 'K', nominals: [192.7, 191.0, 236.8, 211.7, 208.9, 227.4], yoyHist: [7.7, 10.3, 20.7, 15.5, 17.7, 17.1], planNeeded: true },
                nasp: { current: 91, mom: 4.3, yoy: 16.0, plan: -5.0, unit: 'COP', nominals: [82, 85, 88, 88, 90, 91], yoyHist: [-4, 2, 5, 4, 13, 16], planNeeded: true },
                dc: { current: 1.5, mom: 23.7, yoy: 2.3, unit: '%', nominals: [-2.1, -1.1, 0.0, -1.7, -2.2, 1.5], yoyHist: [2.5, 0.6, -0.1, 0.5, -3.3, 2.3], isDifferential: true },
                cvr: { current: 2.0, mom: 0.0, yoy: 0.0, unit: '%', nominals: [2.1, 2.1, 2.1, 2.0, 2.0, 2.0], yoyHist: [0.2, 0.1, 0.1, 0.1, 0.0, 0.0], isDifferential: true },
                kmiCoverage: { current: 88.3, yoy: 10.5 }, bpcTotal: { current: 73.0, yoy: 0.1 }, pddTotal: { current: 2.6, yoy: 0.2 },
                summary: 'MCO con <strong>%NMV_VAL%</strong> (+24.2% YoY), cerrando <strong>-2% vs Plan</strong>. La <strong>DC</strong> (-2.2% YoY) se recupera a <strong>1.5%</strong> (<strong>+2.3 pp YoY</strong>), gracias a un fuerte crecimiento de <strong>TASP +16% YoY</strong>. La rentabilidad (DC) sigue siendo la principal alerta.'
            },
            MLU: {
                nmv: { current: 345.86, mom: -10.2, yoy: 26.0, plan: -3.0, unit: 'M UYU', nominals: [422.6, 339.6, 307.3, 385.1, 345.9, 345.86], yoyHist: [32.5, 20.1, 16.9, 33.3, 26.0, 26.0], planNeeded: true },
                nsi: { current: 226.12, mom: 13.3, yoy: 26.3, plan: 1.0, unit: 'K', nominals: [193.9, 235.7, 215.1, 199.6, 232.5, 226.1], yoyHist: [19.5, 25.4, 21.0, 16.9, 30.5, 26.3], planNeeded: true },
                nasp: { current: 37, mom: 0.0, yoy: 4.0, plan: -5.0, unit: 'UYU', nominals: [37, 42, 38, 37, 40, 37], yoyHist: [-5, 0, -2, 1, 4, 4], planNeeded: true },
                dc: { current: 5.9, mom: -39.3, yoy: -0.2, unit: '%', nominals: [6.7, 6.7, 9.7, 5.1, 5.9, 5.9], yoyHist: [1.8, 1.3, 2.2, -1.6, -0.2, -0.2], isDifferential: true },
                cvr: { current: 1.6, mom: 0.0, yoy: 0.0, unit: '%', nominals: [1.6, 1.7, 1.6, 1.6, 1.6, 1.6], yoyHist: [0.2, 0.1, 0.2, 0.0, 0.0, 0.0], isDifferential: true },
                kmiCoverage: { current: 85.0, yoy: 0.7 }, bpcTotal: { current: 81.0, yoy: -1.7 }, pddTotal: { current: 1.9, yoy: 0.3 },
                summary: 'MLU experimenta un fuerte <i>drag</i> MoM (<strong>-10.2% NMV</strong>) pero mantiene un crecimiento s√≥lido YoY (<strong>+26.0%</strong>). La <strong>DC</strong> cae a <strong>5.9%</strong> (<strong>-0.2 pp YoY</strong>). El <i>gap</i> vs Plan es del -15%.'
            },
            MPE: {
                nmv: { current: 1.42, mom: 9.5, yoy: 33.2, plan: -4.0, unit: 'M PEN', nominals: [1.27, 1.12, 1.68, 1.21, 1.30, 1.42], yoyHist: [29.9, 14.6, 6.9, 9.5, 27.4, 33.2], planNeeded: true },
                nsi: { current: 8.19, mom: 4.7, yoy: 16.5, plan: 0.0, unit: 'K', nominals: [8.23, 7.30, 9.80, 8.17, 8.78, 8.19], yoyHist: [37.8, 22.2, 23.6, 11.3, 31.1, 16.5], planNeeded: true },
                nasp: { current: 51, mom: 4.0, yoy: 25.0, plan: 10.0, unit: 'PEN', nominals: [42, 42, 48, 42, 42, 51], yoyHist: [-15, -4, -2, -9, 4, 25], planNeeded: true },
                dc: { current: 0.6, mom: 140.0, yoy: 3.2, unit: '%', nominals: [-0.6, -3.0, -2.9, -2.4, -4.3, 0.6], yoyHist: [7.5, 0.9, 8.5, 6.9, -2.1, 3.2], isDifferential: true },
                cvr: { current: 1.1, mom: -8.3, yoy: 0.2, unit: '%', nominals: [1.2, 1.1, 1.1, 1.2, 1.1, 1.1], yoyHist: [0.5, 0.4, 0.2, 0.2, 0.3, 0.2], isDifferential: true },
                kmiCoverage: { current: 76.1, yoy: 5.8 }, bpcTotal: { current: 78.7, yoy: -1.7 }, pddTotal: { current: 1.9, yoy: -0.1 },
                summary: 'MPE muestra un fuerte crecimiento de <strong>TASP (+25% YoY)</strong> que empuja el <strong>DC</strong> a positivo (<strong>+0.6%</strong>). El <strong>NMV</strong> crece <strong>+33.2% YoY</strong>, pero el <strong>TSI</strong> tiene un <i>drag</i> MoM. El principal reto es la baja <strong>CVR</strong>.'
            }
        };

        var agg1EvolutionData = {
            LATAM: {  
                'Household Items': { nominals: [170, 172, 186, 186, 177, 183], yoyHist: [34, 36, 32, 33, 32, 28], unit: 'M USD', current: 183, yoy: 28, mom: 3.4 },
                'Furniture': { nominals: [154, 153, 169, 167, 160, 167], yoyHist: [29, 32, 29, 28, 28, 25], unit: 'M USD', current: 167, yoy: 25, mom: 4.4 },
                'Textiles': { nominals: [73, 77, 80, 71, 68, 73], yoyHist: [18, 35, 19, 18, 23, 23], unit: 'M USD', current: 73, yoy: 23, mom: 7.4 },
                'Decor': { nominals: [37, 38, 42, 43, 46, 65], yoyHist: [27, 27, 29, 31, 33, 32], unit: 'M USD', current: 65, yoy: 32, mom: 41.3 },
                'Mattresses & sommier': { nominals: [40, 30, 31, 28, 28, 28], yoyHist: [14, 53, 36, 28, 35, 40], unit: 'M USD', current: 28, yoy: 40, mom: 0.0 },
                'Haberdashery': { nominals: [30, 30, 31, 31, 30, 31], yoyHist: [15, 16, 16, 15, 17, 18], unit: 'M USD', current: 31, yoy: 18, mom: 3.3 }
            },
            MLB: {
                'Household Items': { nominals: [0.087, 0.093, 0.104, 0.107, 0.104, 0.109], yoyHist: [29, 31, 29, 34, 34, 31], unit: 'B BRL', current: 0.109, yoy: 31, mom: 4.8 },
                'Furniture': { nominals: [0.077, 0.082, 0.093, 0.094, 0.091, 0.098], yoyHist: [31, 27, 29, 32, 31, 27], unit: 'B BRL', current: 0.098, yoy: 27, mom: 7.7 },
                'Textiles': { nominals: [0.034, 0.039, 0.042, 0.038, 0.037, 0.041], yoyHist: [15, 32, 20, 21, 29, 30], unit: 'B BRL', current: 0.041, yoy: 30, mom: 10.8 },
                'Decor': { nominals: [0.020, 0.021, 0.024, 0.025, 0.026, 0.036], yoyHist: [15, 15, 17, 22, 29, 31], unit: 'B BRL', current: 0.036, yoy: 31, mom: 38.5 },
                'Mattresses & sommier': { nominals: [0.007, 0.008, 0.009, 0.009, 0.010, 0.010], yoyHist: [35, 52, 47, 53, 66, 46], unit: 'B BRL', current: 0.010, yoy: 46, mom: 0.0 },
                'Haberdashery': { nominals: [0.005, 0.005, 0.006, 0.006, 0.005, 0.006], yoyHist: [10, 12, 14, 13, 15, 16], unit: 'B BRL', current: 0.006, yoy: 16, mom: 20.0 }
            },
            MLM: {
                'Household Items': { nominals: [37, 35, 38, 39, 36, 36], yoyHist: [48, 65, 55, 55, 54, 46], unit: 'M MXN', current: 36, yoy: 46, mom: 0.0 },
                'Furniture': { nominals: [33, 33, 37, 36, 32, 31], yoyHist: [23, 49, 33, 32, 30, 28], unit: 'M MXN', current: 31, yoy: 28, mom: -3.1 },
                'Textiles': { nominals: [15, 15, 17, 16, 15, 16], yoyHist: [38, 55, 37, 39, 38, 34], unit: 'M MXN', current: 16, yoy: 34, mom: 6.7 },
                'Decor': { nominals: [9, 9, 11, 11, 12, 21], yoyHist: [42, 51, 56, 57, 46, 38], unit: 'M MXN', current: 21, yoy: 38, mom: 75.0 },
                'Mattresses & sommier': { nominals: [12, 10, 11, 10, 9, 9], yoyHist: [27, 86, 48, 55, 53, 68], unit: 'M MXN', current: 9, yoy: 68, mom: 0.0 },
                'Haberdashery': { nominals: [3, 4, 4, 5, 5, 6], yoyHist: [20, 22, 24, 23, 25, 26], unit: 'M MXN', current: 6, yoy: 26, mom: 20.0 }
            },
            MLA: {
                'Household Items': { nominals: [38, 35, 35, 32, 28, 29], yoyHist: [33, 29, 21, 12, 10, 4], unit: 'B ARS', current: 29, yoy: 4, mom: 3.6 },
                'Furniture': { nominals: [34, 27, 29, 28, 26, 27], yoyHist: [33, 29, 22, 13, 15, 15], unit: 'B ARS', current: 27, yoy: 15, mom: 3.8 },
                'Textiles': { nominals: [20, 18, 17, 14, 12, 12], yoyHist: [12, 27, 3, -2, -1, -3], unit: 'B ARS', current: 12, yoy: -3, mom: 0.0 },
                'Decor': { nominals: [6, 6, 6, 6, 6, 7], yoyHist: [66, 55, 46, 32, 31, 28], unit: 'B ARS', current: 7, yoy: 28, mom: 16.7 },
                'Mattresses & sommier': { nominals: [19, 8, 9, 7, 7, 7], yoyHist: [-3, 26, 15, -9, 6, 12], unit: 'B ARS', current: 7, yoy: 12, mom: 0.0 },
                'Haberdashery': { nominals: [1, 1, 1, 1, 1, 1], yoyHist: [5, 6, 7, 6, 8, 7], unit: 'B ARS', current: 1, yoy: 7, mom: 0.0 }
            },
            MLC: {
                'Household Items': { nominals: [55, 55, 56, 55, 56, 56], yoyHist: [27, 30, 34, 30, 32, 34], unit: 'M CLP', current: 56, yoy: 34, mom: 0.0 },
                'Furniture': { nominals: [33, 34, 44, 43, 40, 43], yoyHist: [37, 50, 55, 58, 43, 56], unit: 'M CLP', current: 43, yoy: 56, mom: 7.5 },
                'Textiles': { nominals: [3, 4, 3, 3, 3, 4], yoyHist: [22, 5, 31, 25, 26, 33], unit: 'M CLP', current: 4, yoy: 33, mom: 33.3 },
                'Decor': { nominals: [1, 1, 1, 1, 1, 1], yoyHist: [4, 16, 14, 16, 12, 19], unit: 'M CLP', current: 1, yoy: 19, mom: 0.0 },
                'Mattresses & sommier': { nominals: [1, 1, 1, 1, 1, 1], yoyHist: [85, 53, 81, 47, -7, 48], unit: 'M CLP', current: 1, yoy: 48, mom: 0.0 },
                'Haberdashery': { nominals: [0.5, 0.5, 0.6, 0.5, 0.6, 0.7], yoyHist: [10, 12, 14, 13, 15, 16], unit: 'M CLP', current: 0.7, yoy: 16, mom: 16.7 }
            },
            MCO: {
                'Household Items': { nominals: [2, 2, 2, 2, 2, 2], yoyHist: [14, 19, 26, 18, 21, 18], unit: 'B COP', current: 2, yoy: 18, mom: 0.0 },
                'Furniture': { nominals: [2, 2, 2, 2, 2, 2], yoyHist: [18, 14, 34, 28, 29, 30], unit: 'B COP', current: 2, yoy: 30, mom: 0.0 },
                'Textiles': { nominals: [546, 572, 665, 599, 591, 667], yoyHist: [1, 2, 7, 8, 11, 14], unit: 'K COP', current: 667, yoy: 14, mom: 12.9 },
                'Decor': { nominals: [201, 187, 239, 230, 284, 448], yoyHist: [-1, 1, 14, 6, 12, 17], unit: 'K COP', current: 448, yoy: 17, mom: 57.6 },
                'Mattresses & sommier': { nominals: [166, 202, 208, 204, 230, 270], yoyHist: [14, 42, 38, 32, 62, 59], unit: 'K COP', current: 270, yoy: 59, mom: 17.4 },
                'Haberdashery': { nominals: [100, 110, 120, 115, 125, 130], yoyHist: [20, 22, 24, 23, 25, 26], unit: 'K COP', current: 130, yoy: 26, mom: 4.3 }
            },
            MLU: {
                'Household Items': { nominals: [2, 2, 2, 2, 2, 2], yoyHist: [22, 28, 21, 15, 34, 27], unit: 'M UYU', current: 2, yoy: 27, mom: 0.0 },
                'Furniture': { nominals: [4, 5, 4, 4, 5, 5], yoyHist: [28, 32, 20, 18, 33, 26], unit: 'M UYU', current: 5, yoy: 26, mom: 0.0 },
                'Textiles': { nominals: [638, 693, 983, 789, 621, 715], yoyHist: [19, 12, 41, 8, 12, 27], unit: 'K UYU', current: 715, yoy: 27, mom: 15.1 },
                'Decor': { nominals: [307, 339, 348, 349, 416, 487], yoyHist: [29, 27, 31, 24, 35, 27], unit: 'K UYU', current: 487, yoy: 27, mom: 17.1 },
                'Mattresses & sommier': { nominals: [860, 842, 2000, 994, 863, 971], yoyHist: [33, 26, 33, 24, 14, 33], unit: 'K UYU', current: 971, yoy: 33, mom: 12.5 },
                'Haberdashery': { nominals: [150, 160, 170, 165, 175, 180], yoyHist: [10, 12, 14, 13, 15, 16], unit: 'K UYU', current: 180, yoy: 16, mom: 2.9 }
            },
            MPE: {
                'Household Items': { nominals: [1.27, 1.12, 1.68, 1.21, 1.30, 1.42], yoyHist: [29.9, 14.6, 6.9, 9.5, 27.4, 33.2], unit: 'M PEN', current: 1.42, yoy: 33.2, mom: 9.5 },
                'Furniture': { nominals: [1.3, 1.1, 1.3, 1.2, 1.1, 1.1], yoyHist: [20, 18, 17, 14, 12, 19], unit: 'M PEN', current: 1.1, yoy: 19, mom: -8.3 },
                'Textiles': { nominals: [0.5, 0.4, 0.6, 0.5, 0.4, 0.4], yoyHist: [22, 5, 31, 25, 26, 33], unit: 'M PEN', current: 0.4, yoy: 33, mom: 0.0 },
                'Decor': { nominals: [0.1, 0.1, 0.1, 0.1, 0.1, 0.1], yoyHist: [27, 27, 29, 31, 33, 32], unit: 'M PEN', current: 0.1, yoy: 32, mom: 0.0 },
                'Mattresses & sommier': { nominals: [0.2, 0.2, 0.2, 0.2, 0.2, 0.2], yoyHist: [14, 53, 36, 28, 35, 40], unit: 'M PEN', current: 0.2, yoy: 40, mom: 0.0 },
                'Haberdashery': { nominals: [0.05, 0.06, 0.07, 0.06, 0.07, 0.08], yoyHist: [10, 12, 14, 13, 15, 16], unit: 'M PEN', current: 0.08, yoy: 16, mom: 14.3 }
            }
        };

        var bpcEvolutionData = {
            LATAM: {
                'Price BPC KMI (%)': [88.5, 87.0, 85.5, 84.0, 83.0, 82.5],
                'BPC Financing (0% Inter√©s) (%)': [35.0, 35.5, 36.0, 36.5, 37.0, 37.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [75.0, 75.5, 76.0, 76.5, 77.0, 77.5]
            },
            MLB: {
                'Price BPC KMI (%)': [85.0, 83.5, 82.0, 81.0, 80.5, 80.0],
                'BPC Financing (0% Inter√©s) (%)': [30.0, 30.5, 31.0, 31.5, 32.0, 32.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [70.0, 70.5, 71.0, 71.5, 72.0, 72.5]
            },
            MLM: {
                'Price BPC KMI (%)': [90.0, 89.0, 88.0, 87.5, 87.0, 86.5],
                'BPC Financing (0% Inter√©s) (%)': [40.0, 40.5, 41.0, 41.5, 42.0, 42.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [80.0, 80.5, 81.0, 81.5, 82.0, 82.5]
            },
            MLA: {
                'Price BPC KMI (%)': [92.0, 91.0, 90.0, 89.5, 89.0, 88.5],
                'BPC Financing (0% Inter√©s) (%)': [25.0, 25.5, 26.0, 26.5, 27.0, 27.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [65.0, 65.5, 66.0, 66.5, 67.0, 67.5]
            },
            MLC: {
                'Price BPC KMI (%)': [80.0, 79.0, 78.0, 77.5, 77.0, 76.5],
                'BPC Financing (0% Inter√©s) (%)': [30.0, 30.5, 31.0, 31.5, 32.0, 32.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [60.0, 60.5, 61.0, 61.5, 62.0, 62.5]
            },
            MCO: {
                'Price BPC KMI (%)': [85.0, 84.5, 84.0, 83.5, 83.0, 82.5],
                'BPC Financing (0% Inter√©s) (%)': [45.0, 45.5, 46.0, 46.5, 47.0, 47.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [75.0, 75.5, 76.0, 76.5, 77.0, 77.5]
            },
            MLU: {
                'Price BPC KMI (%)': [95.0, 94.5, 94.0, 93.5, 93.0, 92.5],
                'BPC Financing (0% Inter√©s) (%)': [35.0, 35.5, 36.0, 36.5, 37.0, 37.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [85.0, 85.5, 86.0, 86.5, 87.0, 87.5]
            },
            MPE: {
                'Price BPC KMI (%)': [78.0, 77.5, 77.0, 76.5, 76.0, 75.5],
                'BPC Financing (0% Inter√©s) (%)': [20.0, 20.5, 21.0, 21.5, 22.0, 22.5],
                'BPC Shipping (Env√≠o Gratis) (%)': [55.0, 55.5, 56.0, 56.5, 57.0, 57.5]
            }
        };

        var pddSiteData = {
            LATAM: { pdd: [1.8, 1.7, 1.8, 1.7, 1.6, 2.1], hb: [1.8, 1.7, 1.8, 1.7, 1.6, 2.0], ratio: [2.5, 2.5, 2.5, 2.5, 2.5, 2.5] },
            MLB: { pdd: [2.0, 1.9, 2.0, 1.9, 2.0, 1.9], hb: [2.0, 1.9, 2.0, 1.9, 2.0, 1.9], ratio: [3.0, 3.0, 3.0, 3.0, 3.0, 3.0] },
            MLM: { pdd: [1.4, 1.5, 1.5, 1.5, 1.5, 1.4], hb: [1.4, 1.5, 1.5, 1.5, 1.5, 1.4], ratio: [2.0, 2.0, 2.0, 2.0, 2.0, 2.0] },
            MLA: { pdd: [1.8, 1.8, 1.6, 1.6, 1.7, 1.7], hb: [1.8, 1.8, 1.6, 1.6, 1.7, 1.7], ratio: [2.8, 2.8, 2.8, 2.8, 2.8, 2.8] },
            MLC: { pdd: [1.9, 2.0, 1.8, 1.8, 1.8, 1.9], hb: [1.9, 2.0, 1.8, 1.8, 1.8, 1.9], ratio: [2.2, 2.2, 2.2, 2.2, 2.2, 2.2] },
            MCO: { pdd: [2.1, 2.0, 2.0, 2.0, 2.0, 2.0], hb: [2.1, 2.0, 2.0, 2.0, 2.0, 2.0], ratio: [2.8, 2.8, 2.8, 2.8, 2.8, 2.8] },
            MLU: { pdd: [1.8, 1.8, 1.8, 1.7, 1.8, 1.9], hb: [1.8, 1.8, 1.8, 1.7, 1.8, 1.9], ratio: [2.0, 2.0, 2.0, 2.0, 2.0, 2.0] },
            MPE: { pdd: [1.8, 1.7, 1.8, 1.8, 1.9, 1.9], hb: [1.8, 1.7, 1.8, 1.8, 1.9, 1.9], ratio: [2.5, 2.5, 2.5, 2.5, 2.5, 2.5] }
        };

        // --- Core Formatting and Helper Functions ---

        /**
         * Calculates YTD sum from an array of nominal values.
         * @param {number[]} nominals - Array of monthly nominal values.
         * @returns {number} The calculated YTD sum.
         */
        function calculateYtdSum(nominals) {
            return nominals.reduce((sum, value) => sum + value, 0);
        }
        
        function formatNSI(value) {
            if (value >= 1000000) {
                var valM = value / 1000000;
                return "".concat(valM.toFixed(valM >= 10 ? 0 : 1), " M");
            } else if (value >= 1000) {
                var valK = value / 1000;
                return "".concat(valK.toFixed(valK >= 10 ? 0 : 1), " K");
            }
            return value.toFixed(1);
        }
        
        function formatPercent(value) {
            var fixed = value.toFixed(1);
            return "".concat(value >= 0 ? '+' : '').concat(fixed, "%");
        }
        function formatDifferential(value) {
            var fixed = value.toFixed(1);
            return "".concat(value >= 0 ? '+' : '').concat(fixed, " pp");
        }
        function formatYoYLabel(value, isDifferential) {
            if (isDifferential) {
                return "".concat(value >= 0 ? '+' : '').concat(value.toFixed(1), " pp");
            } else {
                return "".concat(value.toFixed(0), "%"); 
            }
        }
        
        function getChangeStatus(value) {
            if (value > 0) return { sign: 'üü¢ +', class: 'kpi-change-green' };
            if (value < 0) return { sign: 'üî¥ ', class: 'kpi-change-red' };
            return { sign: '‚ÜîÔ∏è ', class: 'kpi-change-neutral' };
        }
        
        // --- UI Update Logic (Big Numbers & Cards) ---
        
        function updateBigNumbers(siteCode) {
            // Fallback to LATAM if siteCode data is invalid
            var data = dynamicKpiData[siteCode] || dynamicKpiData.LATAM;
            var latamData = dynamicKpiData.LATAM;
            
            // 1. Update the main header KPI (YTD for the selected site)
            var YTD_NMV_SUM = calculateYtdSum(data.nmv.nominals);
            var unitParts = data.nmv.unit.split(' ');
            var YTD_Unit = unitParts[0] || ''; 
            var YTD_Suffix = unitParts[1] || ''; // Currency, e.g., 'USD'
            
            var formattedYTD;
            if (YTD_Unit === 'B') {
                // If it's B (Billion), display in B, unless it's a very small B, then display in M for readability
                if (YTD_NMV_SUM >= 1) {
                    formattedYTD = YTD_NMV_SUM.toFixed(2) + ' B'; 
                } else {
                    formattedYTD = (YTD_NMV_SUM * 1000).toFixed(0) + ' M';
                }
            } else if (YTD_Unit === 'M') {
                 formattedYTD = YTD_NMV_SUM.toFixed(1) + ' M';
            } else {
                // For other units like K or just currency
                formattedYTD = YTD_NMV_SUM.toFixed(1) + ' ' + YTD_Unit;
            }

            document.getElementById('mainKpiValue').textContent = formattedYTD;
            // Note: The YTD header label always uses the currency suffix of the selected site
            document.getElementById('mainKpiCard').querySelector('.kpi-label-large').textContent = "NMV YTD (".concat(YTD_Suffix, " - Ene - Oct '25)");
            
            // Note: The YTD vs. Plan/YoY metrics in the header always use LATAM (Aggregated) data
            var planText = "<span class=\"".concat(latamData.nmv.plan < 0 ? 'kpi-change-red' : 'kpi-change-green', "\">").concat(latamData.nmv.plan, "% ").concat(latamData.nmv.plan < 0 ? 'üî¥' : 'üü¢', "</span>");
            var yoyText = "<span class=\"".concat(latamData.nmv.yoy > 0 ? 'kpi-change-green' : 'kpi-change-red', "\">").concat(latamData.nmv.yoy, "% ").concat(latamData.nmv.yoy > 0 ? 'üü¢' : 'üî¥', "</span>");

            document.getElementById('mainKpiVsPlan').innerHTML = planText;
            document.getElementById('mainKpiYoY').innerHTML = yoyText;

            // 2. Update Top Line Summary
            var nmvFormattedForSummary = data.nmv.current.toFixed(1) + ' ' + YTD_Unit + ' ' + YTD_Suffix;
            var summaryText = data.summary
                .replace('%NMV_VAL%', nmvFormattedForSummary)
                .replace(/\(datos LATAM\)/g, "(datos ".concat(siteCode, ")")); // Update the source reference
            document.getElementById('toplineSummaryText').innerHTML = summaryText;
            
            // 3. Update individual Big Number Cards (Monthly KPIs)
            var keys = ['nmv', 'nsi', 'nasp', 'dc', 'cvr'];
            keys.forEach(function (key) {
                var item = data[key];
                var isDifferential = item.isDifferential;
                
                var momStatus = getChangeStatus(item.mom);
                var yoyStatus = getChangeStatus(item.yoy);
                var planStatus = getChangeStatus(item.plan || 0);

                var itemUnitParts = item.unit.split(' ');
                var itemUnitIndicator = itemUnitParts[0] || '';
                var itemCurrencySuffix = itemUnitParts[1] || '';
                
                // --- FIX: Correct KPI Label Text Generation ---
                var kpiName = key.toUpperCase();
                var labelText = "".concat(kpiName, " (").concat(itemUnitIndicator).concat(itemCurrencySuffix ? ' ' + itemCurrencySuffix : '', ")");
                
                // Handle special case for percentage KPIs like DC/CVR
                if (itemUnitIndicator === '%') {
                    labelText = "".concat(kpiName, " (%)");
                }
                
                document.getElementById("kpi".concat(key.charAt(0).toUpperCase() + key.slice(1), "Label")).textContent = labelText;

                // Value Formatting
                var value = item.current;
                var formattedValue;
                if (key === 'nmv') formattedValue = "".concat(value.toFixed(2), " ").concat(itemUnitIndicator);
                else if (key === 'nsi') formattedValue = formatNSI(value);
                else if (key === 'nasp') formattedValue = (itemCurrencySuffix === 'USD' || itemCurrencySuffix === 'ARS' ? '$' : '') + value.toFixed(value >= 100 ? 0 : 2);
                else formattedValue = "".concat(value.toFixed(1), "%");
                
                document.getElementById("kpi".concat(key.charAt(0).toUpperCase() + key.slice(1), "Value")).textContent = formattedValue;

                // MoM
                var momText = isDifferential ? formatDifferential(item.mom) : formatPercent(item.mom);
                var momElement = document.getElementById("kpi".concat(key.charAt(0).toUpperCase() + key.slice(1), "MoM"));
                momElement.className = "flex-1 text-center ".concat(momStatus.class);
                momElement.innerHTML = "".concat(momStatus.sign).concat(momText, " MoM");
                
                // YoY
                var yoyText = isDifferential ? formatDifferential(item.yoy) : "".concat(item.yoy.toFixed(1), "%");
                var yoyElement = document.getElementById("kpi".concat(key.charAt(0).toUpperCase() + key.slice(1), "YoY"));
                yoyElement.className = "flex-1 text-center ".concat(yoyStatus.class);
                yoyElement.innerHTML = "".concat(yoyStatus.sign).concat(yoyText, " YoY");

                // Plan (Only if planNeeded is true)
                var planElement = document.getElementById("kpi".concat(key.charAt(0).toUpperCase() + key.slice(1), "Plan"));
                if (planElement) {
                    if (item.planNeeded) {
                        var planText_1 = "".concat(item.plan.toFixed(0), "%");
                        planElement.className = "flex-1 text-center ".concat(planStatus.class);
                        planElement.innerHTML = "".concat(planStatus.sign).concat(planText_1, " vs Plan");
                        planElement.style.display = 'block';
                    } else {
                        planElement.style.display = 'none';
                    }
                }
            });

            // 5. Update Selection Cards (Use the pdd/kmicoverage data from dynamicKpiData)
            var kmiStatus = (data.kmiCoverage.current >= 95) ? { text: 'üü¢ OK', class: 'kpi-change-green' } : { text: 'üü° Foco', class: 'kpi-change-neutral' };
            if (document.getElementById('kmiCoverageValue')) {
                document.getElementById('kmiCoverageValue').textContent = "".concat(data.kmiCoverage.current.toFixed(1), "%");
                document.getElementById('kmiCoverageYoY').textContent = formatDifferential(data.kmiCoverage.yoy);
                document.getElementById('kmiCoverageStatus').className = "text-lg font-bold ".concat(kmiStatus.class);
                document.getElementById('kmiCoverageStatus').textContent = kmiStatus.text;
            }

            var bpcStatus = (data.bpcTotal.current >= 75) ? { text: 'üü¢ OK', class: 'kpi-change-green' } : { text: 'üü° Foco', class: 'kpi-change-neutral' };
            if (document.getElementById('bpcTotalValue')) {
                document.getElementById('bpcTotalValue').textContent = "".concat(data.bpcTotal.current.toFixed(1), "%");
                document.getElementById('bpcTotalYoY').textContent = formatDifferential(data.bpcTotal.yoy);
                document.getElementById('bpcTotalStatus').className = "text-lg font-bold ".concat(bpcStatus.class);
                document.getElementById('bpcTotalStatus').textContent = bpcStatus.text;
            }

            // NMV Hunting vs Plan KPI Update
            var nmvPlanValue = data.nmv.plan;
            var huntingStatus = getChangeStatus(nmvPlanValue);
            var huntingText = "".concat(nmvPlanValue.toFixed(0), "%");
            var huntingValue = huntingStatus.sign + huntingText;
            var huntingLabel = nmvPlanValue >= 0 ? 'üü¢ OK' : 'üî¥ Desv√≠o';

            if (document.getElementById('kpiNmvHuntingValue')) {
                document.getElementById('kpiNmvHuntingValue').textContent = huntingValue;
                document.getElementById('kpiNmvHuntingPlan').textContent = huntingText;
                document.getElementById('kpiNmvHuntingStatus').className = "text-lg font-bold ".concat(huntingStatus.class);
                document.getElementById('kpiNmvHuntingStatus').textContent = huntingLabel;
            }
            
            // 4. Update Header country text 
            var siteNameMap = {
                'LATAM': 'MELI (LATAM)', 'MLB': 'Brasil (BRL)', 'MLM': 'M√©xico (MXN)', 'MLA': 'Argentina (ARS)',
                'MLC': 'Chile (CLP)', 'MCO': 'Colombia (COP)', 'MLU': 'Uruguay (UYU)', 'MPE': 'Per√∫ (PEN)'
            };
            document.querySelector('header p').textContent = "Octubre 2025 ‚Äì ".concat(siteNameMap[siteCode]);
            document.getElementById('bpcChartSiteName').textContent = document.getElementById('siteSelectorGlobal').options[document.getElementById('siteSelectorGlobal').selectedIndex].text.split('(')[0].trim();
        }

        // --- Chart Creation/Update Logic ---

        function destroyChartInstances(ids) {
            ids.forEach(function (id) {
                if (chartInstances[id]) {
                    chartInstances[id].destroy();
                    delete chartInstances[id];
                }
            });
        }

        function createCombinedChart(ctxId, dataSet, nominalColor, lineColor, isPercentage, isDifferential) {
            var siteCode = document.getElementById('siteSelectorGlobal').value;
            var chartData = dynamicKpiData[siteCode] || dynamicKpiData.LATAM;
            
            var ctx = document.getElementById(ctxId);
            if (!ctx) return;
            
            if (chartInstances[ctxId]) chartInstances[ctxId].destroy();
            
            var dataSetItem = chartData[dataSet]; // Use dataSetItem here
            
            var nominalData = dataSetItem.nominals.slice(-6);
            var yoyData = dataSetItem.yoyHist.slice(-6);
            var nominalUnit = dataSetItem.unit;
            var unitType = nominalUnit.split(' ')[0];
            var currencySuffix = nominalUnit.split(' ')[1] || '';
            
            // Callback for nominal axis/tooltips
            var nominalCallback = function (value) {
                if (dataSet === 'nsi') return formatNSI(value);
                if (isPercentage) return "".concat(value.toFixed(1), "%");
                if (dataSet === 'nasp') return (currencySuffix === 'USD' || currencySuffix === 'ARS' ? '$' : '') + value.toFixed(value >= 100 ? 0 : 2);
                if (unitType === 'M' || unitType === 'B') return "".concat(value.toFixed(1), " ").concat(unitType); // Simplified M/B unit display
                return value.toFixed(1);
            };
            
            // Update title
            var currentNominal = nominalCallback(dataSetItem.current);
            var yoyLabel = formatYoYLabel(dataSetItem.yoy, isDifferential);
            var momLabel = formatPercent(dataSetItem.mom);
            document.getElementById(ctxId.replace('Chart', 'ChartTitle')).textContent = 
                "".concat(dataSet.toUpperCase(), ": ").concat(currentNominal, " | YoY: ").concat(yoyLabel, " | MoM: ").concat(momLabel);

            var newChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: kpiLabels.slice(-nominalData.length),
                    datasets: [
                        {
                            type: 'bar',
                            label: "Nominal (".concat(nominalUnit, ")"),
                            data: nominalData,
                            backgroundColor: nominalColor,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'YoY (%)',
                            data: yoyData,
                            borderColor: lineColor,
                            backgroundColor: lineColor,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: nominalData.some(function (v) { return v < 0; }) ? false : true,
                            title: { display: true, text: nominalUnit, color: nominalColor.replace('0.5', '1') },
                            ticks: { callback: nominalCallback, color: nominalColor.replace('0.5', '1') }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'YoY (%)', color: lineColor },
                            ticks: {
                                callback: function (value) { return "".concat(value.toFixed(1)).concat(isDifferential ? ' pp' : '%'); },
                                color: lineColor
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false, callbacks: {
                            label: function (context) {
                                var value = context.parsed.y;
                                var label = context.dataset.label;
                                var formattedValue;
                                if (context.dataset.type === 'line') {
                                    formattedValue = formatYoYLabel(value, isDifferential);
                                } else {
                                    formattedValue = nominalCallback(value) + (currencySuffix ? " ".concat(currencySuffix) : '');
                                }
                                return "".concat(label, ": ").concat(formattedValue);
                            }
                        }},
                        datalabels: { formatter: function () { return null; } }
                    }
                }
            });
            chartInstances[ctxId] = newChart;
        }

        function createBpcLineChart(ctxId, dataSet) {
            var siteCode = document.getElementById('siteSelectorGlobal').value;
            var data = bpcEvolutionData[siteCode] || bpcEvolutionData.LATAM;
            
            var dataSetItem = data[dataSet]; // Use dataSetItem here
            var ctx = document.getElementById(ctxId);

            if (chartInstances[ctxId]) chartInstances[ctxId].destroy();

            // Determine dynamic min/max based on data (keeping 100% as max for percentages)
            var yMin = 20;  
            var yMax = 100;


            chartInstances[ctxId] = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: kpiLabels.slice(-dataSetItem.length),
                    datasets: [{
                        label: dataSet,
                        data: dataSetItem.slice(-6),
                        borderColor: color4,
                        backgroundColor: color4Bg,
                        fill: true, // Se cambi√≥ a fill: true para un mejor aspecto
                        tension: 0.4, // Se mejor√≥ la tensi√≥n para curvas m√°s suaves
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: yMin, // Adjusted min value
                            max: yMax,
                            ticks: {
                                callback: function (value) { return value + '%'; }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: function (context) {
                                return "".concat(context.dataset.label, ": ").concat(context.parsed.y.toFixed(1), "%");
                            }
                        }},
                        datalabels: { formatter: function () { return null; } }
                    }
                }
            });
            document.getElementById('bpcChartSiteName').textContent = document.getElementById('siteSelectorGlobal').options[document.getElementById('siteSelectorGlobal').selectedIndex].text.split('(')[0].trim();
        }

        function createPddQualityChart(siteCode) {
            var data = pddSiteData[siteCode] || pddSiteData.LATAM;
            
            var ctxId = 'pddQualityChart';
            var ctx = document.getElementById(ctxId);

            if (chartInstances[ctxId]) chartInstances[ctxId].destroy();

            var pddChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: kpiLabels,
                    datasets: [
                        {
                            label: 'PDD Vertical F&H (%)',
                            data: data.pdd,
                            borderColor: color2,
                            backgroundColor: color2Bg,
                            fill: false,
                            tension: 0.3,
                        },
                        {
                            label: 'PDD H&B Total (%)',
                            data: data.hb,
                            borderColor: color4,
                            backgroundColor: color4Bg,
                            fill: false,
                            tension: 0.3,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Target PDD (%)',
                            data: data.ratio,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            fill: false,
                            pointRadius: 0,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 5,
                            ticks: {
                                callback: function (value) { return value.toFixed(1) + '%'; }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: {
                            label: function (context) {
                                return "".concat(context.dataset.label, ": ").concat(context.parsed.y.toFixed(2), "%");
                            }
                        }},
                        datalabels: { formatter: function () { return null; } }
                    }
                }
            });
            chartInstances[ctxId] = pddChart;
            document.getElementById('pddChartTitle').textContent = "PDD Vertical vs. H&B (".concat(siteCode, " - √öltimos 6 meses)");
        }


        // --- AGG1 Evolution Chart Creator (DYNAMIC) ---
        function createAgg1CombinedChart(agg1Name, data) {
            var chartId = "agg1Chart-".concat(agg1Name.replace(/[^a-zA-Z0-9]/g, ''));
            
            var unitParts = data.unit.split(' ');
            var unitType = unitParts[0];
            var currencySuffix = unitParts[1];

            // Assign colors based on agg1 name
            var nominalColor, lineColor;
            switch(agg1Name) {
                case 'Household Items': nominalColor = meliYellowBg; lineColor = color2; break;
                case 'Furniture': nominalColor = color2Bg; lineColor = color4; break;
                case 'Textiles': nominalColor = color4Bg; lineColor = color3; break;
                case 'Decor': nominalColor = color3Bg; lineColor = color5; break;
                case 'Mattresses & sommier': nominalColor = color5Bg; lineColor = meliYellow; break;
                case 'Haberdashery': nominalColor = color6Bg; lineColor = color6; break;
                default: nominalColor = meliYellowBg; lineColor = color2;
            }

            var chartHtml = "\n            <div class=\"kpi-card\">\n                <h3 class=\"text-lg font-bold mb-1 text-center\">".concat(agg1Name, " - NMV Evoluci\xF3n</h3>\n                <h4 class=\"text-sm font-semibold mb-3 text-center\">Act.: ").concat(data.current.toFixed(1), " ").concat(unitType, " | YoY: ").concat(data.yoy, "% | MoM: ").concat(formatPercent(data.mom), "</h4>\n                <div class=\"chart-container\" style=\"height: 250px;\">\n                    <canvas id=\"").concat(chartId, "\"></canvas>\n                </div>\n            </div>\n        ");
            var agg1Container = document.getElementById('agg1ChartsContainer');
            if (agg1Container) {
                agg1Container.insertAdjacentHTML('beforeend', chartHtml);
            }

            var ctx = document.getElementById(chartId);
            if (!ctx) return;
            
            if (chartInstances[chartId]) chartInstances[chartId].destroy();
            
            var nominalData = data.nominals.slice(-6);
            var yoyData = data.yoyHist.slice(-6);

            var nominalCallback = function (value) {
                if (unitType === 'B') return "".concat(value.toFixed(2), " B"); 
                if (unitType === 'M') return "".concat(value.toFixed(1), " M"); 
                if (unitType === 'K') return "".concat(value.toFixed(0), " K"); 
                return "".concat(value.toFixed(1)); 
            };

            var newChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: kpiLabels.slice(-nominalData.length),
                    datasets: [
                        {
                            type: 'bar',
                            label: "NMV Nominal (".concat(unitType, " ").concat(currencySuffix, ")"),
                            data: nominalData,
                            backgroundColor: nominalColor,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'YoY (%)',
                            data: yoyData,
                            borderColor: lineColor,
                            backgroundColor: lineColor,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: "NMV (".concat(unitType, " ").concat(currencySuffix, ")"), color: nominalColor.replace('0.5', '1') },
                            ticks: { callback: nominalCallback, color: nominalColor.replace('0.5', '1') }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'YoY (%)', color: lineColor },
                            ticks: {
                                callback: function (value) { return "".concat(value.toFixed(0), "%"); },
                                color: lineColor
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false, callbacks: {
                            label: function (context) {
                                var value = context.parsed.y;
                                var label = context.dataset.label;
                                var formattedValue;
                                if (context.dataset.type === 'line') {
                                    formattedValue = "".concat(value.toFixed(0), "%");
                                } else {
                                    formattedValue = nominalCallback(value) + (currencySuffix ? " ".concat(currencySuffix) : '');
                                }
                                return "".concat(label, ": ").concat(formattedValue);
                            }
                        }},
                        datalabels: { formatter: function () { return null; } }
                    }
                }
            });
            chartInstances[chartId] = newChart;
        }

        function renderAgg1Charts(siteCode) {
            var agg1Container = document.getElementById('agg1ChartsContainer');
            
            // 1. Destroy and clear old charts
            Object.keys(chartInstances).filter(function (key) { return key.startsWith('agg1Chart-'); }).forEach(function (id) {
                if (chartInstances[id]) {
                    chartInstances[id].destroy();
                    delete chartInstances[id];
                }
            });
            if (agg1Container) agg1Container.innerHTML = ''; 
            
            // 2. Get AGG1 Data for the site (with LATAM fallback)
            var siteData = agg1EvolutionData[siteCode] || agg1EvolutionData.LATAM;
            
            // Get overall F&H YoY growth for analysis text
            var fnhYoY = dynamicKpiData[siteCode] ? dynamicKpiData[siteCode].nmv.yoy : dynamicKpiData.LATAM.nmv.yoy; 
            
            
            // Prepare list of AGG1s for sorting (by nominal value)
            var agg1List = Object.entries(siteData).map(function(_a) {
                var name = _a[0], data = _a[1];
                return { name: name, current: data.current, yoy: data.yoy, data: data };
            });

            // Sort descending by current NMV
            agg1List.sort(function(a, b) { return b.current - a.current; });

            // Construct the analysis string (using the logic from the analysis phase)
            var analysisText = "El NMV est√° impulsado principalmente por el crecimiento explosivo de categor√≠as como <strong>Mattresses & sommier (+40% YoY)</strong>, <strong>Decor (+32% YoY)</strong> y <strong>Household Items (+28% YoY)</strong>. El rezago clave sigue siendo la <strong>KB Furniture</strong> (25% YoY) que crece por debajo del promedio del vertical (28% YoY), principalmente por el <i>underperformance</i> en MLB, MLA y MLU.";

            // 3. Update Title with Currency
            var unitParts = siteData['Household Items'].unit.split(' ');
            var unitType = unitParts[0];
            var currencySuffix = unitParts[1] || 'LC';
            var currencyLabel = "(".concat(currencySuffix, ")");
            document.getElementById('agg1EvolutionTitle').textContent = "Performance NMV per AGG1 ".concat(currencyLabel);

            // Update the text in the DOM
            var analysisElement = document.getElementById('agg1AnalysisText');
            if(analysisElement) {
                analysisElement.innerHTML = analysisText;
            }
            
            // 4. Create Charts
            agg1List.forEach(function (item) {
                createAgg1CombinedChart(item.name, item.data);
            });
        }
        
        // --- ASP Range Chart Creator (Horizontal Bar) ---
        function createAspHorizontalBarChart(ctxId, dataSet, nominalColor, label) {
            var siteCode = document.getElementById('siteSelectorGlobal').value;
            // Fallback to LATAM data if site-specific ASP data is missing
            var data = aspRangeData[siteCode] || aspRangeData['LATAM'];
            var ctx = document.getElementById(ctxId);
            
            // --- DYNAMICALLY SET LABELS ---
            var currentAspLabels = aspRangesBySite[siteCode] || aspRangesBySite['LATAM']; 
            
            // Filter out N/A ranges before passing to chart
            var validLabels = [];
            var validData = [];
            currentAspLabels.forEach(function(lbl, index) {
                // Check if label contains N/A (case-insensitive)
                if (lbl.toUpperCase().indexOf('N/A') === -1) {
                    validLabels.push(lbl.split(' ')[0]); // Use short label (e.g., LOW1, MID2)
                    validData.push(data[dataSet][index]);
                }
            });

            if (chartInstances[ctxId]) chartInstances[ctxId].destroy();

            var chartData = validData;
            
            // Format callback depends on the dataset
            var callback = function(value) {
                if (dataSet === 'nmv') return value.toFixed(1) + ' M';
                if (dataSet === 'nsi') return formatNSI(value);
                if (dataSet === 'dc' || dataSet === 'cvr') return value.toFixed(1) + '%';
                if (dataSet === 'bpc') return value.toFixed(0) + '%';
                return value.toFixed(1);
            };

            chartInstances[ctxId] = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: validLabels,
                    datasets: [{
                        label: label,
                        data: chartData,
                        backgroundColor: nominalColor,
                        borderColor: nominalColor.replace('0.5', '1'),
                        borderWidth: 1,
                        borderRadius: 4,
                        barThickness: 15
                    }]
                },
                options: {
                    indexAxis: 'y', // Make it a horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: {
                                callback: callback,
                                maxTicksLimit: 5,
                                autoSkip: true
                            }
                        },
                        y: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: function(context) {
                                return "".concat(label, ": ").concat(callback(context.parsed.x));
                            }
                        }},
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#333',
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            formatter: callback
                        }
                    }
                }
            });
        }
        
        // --- VISIBILITY TOGGLE ---
        function toggleConditionalSections(siteCode) {
            var mlbHousewareSection = document.getElementById('plan-mlb-houseware');
            if (!mlbHousewareSection) return;

            // Mostrar solo si el sitio es LATAM o MLB
            if (siteCode === 'LATAM' || siteCode === 'MLB') {
                mlbHousewareSection.classList.remove('hidden-by-filter');
            } else {
                mlbHousewareSection.classList.add('hidden-by-filter');
            }
        }


        function initializeCharts(siteCode) {
            
            // 1. Update Big Numbers UI and Card Data (Includes YTD FIX)
            updateBigNumbers(siteCode);
            
            // 2. Destroy and Render Main KPI Evolution Charts
            destroyChartInstances(['nmvChart', 'nsiChart', 'naspChart', 'dcChart', 'cvrChart']);
            var chartsToCreate = [
                { id: 'nmvChart', dataset: 'nmv', nominalColor: meliYellowBg, lineColor: color2, isPercentage: false, isDifferential: false },
                { id: 'nsiChart', dataset: 'nsi', nominalColor: color4Bg, lineColor: color2, isPercentage: false, isDifferential: false },
                { id: 'naspChart', dataset: 'nasp', nominalColor: color3Bg, lineColor: meliYellow, isPercentage: false, isDifferential: false },
                { id: 'dcChart', dataset: 'dc', nominalColor: color4Bg, lineColor: meliYellow, isPercentage: true, isDifferential: true },
                { id: 'cvrChart', dataset: 'cvr', nominalColor: meliYellowBg, lineColor: color2, isPercentage: true, isDifferential: true }
            ];
            chartsToCreate.forEach(function (c) { return createCombinedChart(c.id, c.dataset, c.nominalColor, c.lineColor, c.isPercentage, c.isDifferential); });

            // 3. Initialize AGG1 Charts
            renderAgg1Charts(siteCode);

            // 4. Initialize BPC Charts (Static Data based on site selector)
            destroyChartInstances(['bpcKiChart', 'bpcFinancingChart', 'bpcShippingChart']);
            createBpcLineChart('bpcKiChart', 'Price BPC KMI (%)');
            createBpcLineChart('bpcFinancingChart', 'BPC Financing (0% Inter√©s) (%)');
            createBpcLineChart('bpcShippingChart', 'BPC Shipping (Env√≠o Gratis) (%)');

            // 5. Initialize PDD Chart
            destroyChartInstances(['pddQualityChart']);
            createPddQualityChart(siteCode);

            // 6. Initialize ASP Charts
            destroyChartInstances(['aspNmvChart', 'aspNsiChart', 'aspDcChart', 'aspCvrChart', 'aspBpcChart']);
            createAspHorizontalBarChart('aspNmvChart', 'nmv', meliYellowBg, 'NMV (M)');
            createAspHorizontalBarChart('aspNsiChart', 'nsi', color4Bg, 'TSI (K)');
            createAspHorizontalBarChart('aspDcChart', 'dc', color3Bg, 'DC (%)');
            createAspHorizontalBarChart('aspCvrChart', 'cvr', color2Bg, 'CVR (%)');
            createAspHorizontalBarChart('aspBpcChart', 'bpc', color5Bg, 'BPC (%)');

            // 7. Toggle visibility for conditional sections (MLB Houseware)
            toggleConditionalSections(siteCode);
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            var siteSelector = document.getElementById('siteSelectorGlobal');
            
            if (siteSelector) {
                var initialSiteCode = siteSelector.value || 'LATAM'; 
                
                // Initial load: ensure charts are drawn for the default/selected value
                initializeCharts(initialSiteCode); 
                
                // Set up change listener
                siteSelector.addEventListener('change', function (e) {
                    initializeCharts(e.target.value);
                });
            }
        });
    </script>
</body>
</html>
